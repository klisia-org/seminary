var C=(N,_,f)=>new Promise((c,n)=>{var b=u=>{try{p(f.next(u))}catch(y){n(y)}},m=u=>{try{p(f.throw(u))}catch(y){n(y)}},p=u=>u.done?c(u.value):Promise.resolve(u.value).then(b,m);p((f=f.apply(N,_)).next())});import{F as z,bV as B,r as g,av as I,c as j,I as P,t as l,b as r,g as a,e as k,u as i,D as o,H as S,O,n as F,z as w,c8 as L,w as U,bS as q,L as H,cg as J,C as $,ch as G}from"./vendor-CrP-kEM1.js";import{v as K,c as x,u as Q,d as W,b as X,t as Y}from"./frappe-ui-Qp90XKmJ.js";const Z={class:"sticky top-0 z-10 flex items-center justify-between border-b bg-surface-white px-3 py-2.5 sm:px-5"},ee={class:"flex flex-row h-full"},te={class:"w-1/4 p-4 border-r"},se={class:"text-lg font-semibold mb-4"},ae={class:"flex flex-col space-y-2"},ne=["disabled","onClick","title"],oe={key:0,class:"text-green-500"},le={class:"w-3/4 p-4"},re={key:0,class:"text-gray-500 text-lg font-semibold mb-4"},ue={key:1,class:"w-3/4 p-4"},ce={class:"text-lg font-semibold mb-4"},de={key:0,class:"mb-4"},ie=["title"],_e={key:1,class:"min-w-full table-auto border-collapse"},me={class:"p-2 border"},fe={class:"p-2 border"},he={class:"p-2 border"},be={class:"p-2 border"},pe={class:"flex items-center justify-center space-x-4"},ve=["href"],ye={class:"p-2 border"},ge={class:"p-2 border text-center"},ke={key:0,class:"text-green-500 font-semibold"},we={key:1,class:"text-red-500 font-semibold"},Ce=["onUpdate:modelValue"],Se={key:2,class:"mb-4"},xe={class:"text-lg font-semibold mt-4"},Ne={class:"text-green-500"},Ae={class:"text-red-500"},De={key:3,class:"mt-4"},je={__name:"StudentAttendanceCS",props:{courseName:{type:String,required:!0}},setup(N){z(),B();const _=N,f=new Date,c=g(null),n=g({}),b=g(!1),m=g(!1);g(null);const p=x({url:"seminary.seminary.utils.get_course_meetingdates",makeParams(){return{course:_.courseName}},auto:!0});console.log("Meeting dates: ",p);const u=x({url:"frappe.client.get_list",makeParams(){return{doctype:"Scheduled Course Roster",filters:{course_sc:_.courseName,audit_bool:0,active:1},fields:["student","stuname_roster","stuimage","stuemail_rc"],order_by:"stuname_roster asc"}},auto:!0}),y=e=>G(e).format("MMM D"),v=x({url:"frappe.client.get_list",makeParams(){var e;return{doctype:"Student Attendance",filters:{course_schedule:_.courseName,date:(e=c.value)==null?void 0:e.cs_meetdate},fields:["student","status","date"]}},auto:!1});I(()=>{A.value===0&&(m.value=!0)}),P(()=>v.data,e=>{e&&(n.value={},e.forEach(d=>{var t;d.date===((t=c.value)==null?void 0:t.cs_meetdate)?n.value[d.student]=d.status==="Present":n.value[d.student]=!1}),b.value=Object.keys(n.value).length>0)}),P(()=>c.value,e=>C(this,null,function*(){e&&(v.data=yield v.reload(),console.log("Attendance data reloaded: ",v.data),console.log("Selected date: ",c.value),v.data.length===0&&(n.value={},u.data.forEach(d=>{n.value[d.student]=!1})))}));const M=e=>C(this,null,function*(){c.value=e,m.value=!1,yield v.reload()}),V=()=>{m.value=!0},A=j(()=>Object.values(n.value).filter(e=>e).length),E=j(()=>Object.values(n.value).filter(e=>!e).length);P(A,e=>{e===0&&(m.value=!0)});const R=()=>C(this,null,function*(){const e=Object.keys(n.value).filter(t=>n.value[t]).map(t=>{const s=u.data.find(h=>h.student===t);return s?{student:t,stuname_roster:s.stuname_roster}:(console.error(`Student not found in students.data: ${t}`),null)}).filter(t=>t!==null),d=Object.keys(n.value).filter(t=>!n.value[t]).map(t=>{const s=u.data.find(h=>h.student===t);return s?{student:t,stuname_roster:s.stuname_roster}:(console.error(`Student not found in students.data: ${t}`),null)}).filter(t=>t!==null);yield fetch("/api/method/seminary.seminary.api.mark_attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({course_schedule:_.courseName,date:c.value.cs_meetdate,students_present:e,students_absent:d})}).then(t=>t.json()).then(t=>{t.message&&(Y.success(__("Attendance updated successfully")),p.reload(),v.reload())}).catch(t=>{console.error("Error:",t)})}),D=x({url:"seminary.seminary.utils.get_course_details",cache:["course",_.courseName],params:{course:_.courseName},auto:!0}),T=j(()=>{var d;let e=[{label:"Courses",route:{name:"Courses"}}];return e.push({label:(d=D==null?void 0:D.data)==null?void 0:d.course,route:{name:"CourseDetail",params:{courseName:_.courseName}}}),e.push({label:"Attendance",route:{name:"StudentAttendanceCS",params:{courseName:_.courseName}}}),e});return(e,d)=>{var t;return r(),l(S,null,[a("header",Z,[k(i(Q),{class:"h-7",items:T.value},null,8,["items"])]),a("div",ee,[a("div",te,[a("h2",se,o(e.__("Course Schedule")),1),a("div",ae,[(r(!0),l(S,null,O(i(p).data,s=>{var h;return r(),l("button",{key:s.name,disabled:new Date(s.cs_meetdate)>i(f),class:F(["p-2 border rounded-md text-left flex justify-between items-center",{"bg-gray-200":new Date(s.cs_meetdate)>i(f),"bg-blue-100":((h=c.value)==null?void 0:h.name)===s.name}]),onClick:Pe=>M(s),title:new Date(s.cs_meetdate)>i(f)?e.__("Cannot set attendance of future dates"):""},[a("span",null,o(y(s.cs_meetdate)),1),s.attendance===1?(r(),l("span",oe,[k(i(L),{class:"h-5 w-5 text-green-500"})])):w("",!0)],10,ne)}),128))])]),a("div",le,[!i(u).data||i(u).data.length===0?(r(),l("div",re,o(e.__("There are no students enrolled in this course.")),1)):(r(),l("div",ue,[a("h2",ce,o(e.__("Attendance for: "))+" "+o(((t=c.value)==null?void 0:t.cs_meetdate)||e.__("Select a date")),1),b.value&&!m.value?(r(),l("div",de,[a("button",{class:"p-2 bg-yellow-200 border rounded-md",onClick:V,title:e.__("All changes will be recorded for audit purposes")},o(e.__("Edit Attendance")),9,ie)])):w("",!0),c.value?(r(),l("table",_e,[a("thead",null,[a("tr",null,[a("th",me,o(e.__("Image")),1),a("th",fe,o(e.__("Student Name")),1),a("th",he,o(e.__("Present")),1)])]),a("tbody",null,[(r(!0),l(S,null,O(i(u).data,s=>(r(),l("tr",{key:s.student},[a("td",be,[a("div",pe,[k(i(W),{image:s.stuimage,label:s.stuname_roster,size:"md",class:"avatar border border-outline-gray-2 cursor-auto"},null,8,["image","label"]),k(i(X),{text:`Send Email to ${s.stuname_roster}`,placement:"bottom","arrow-class":"fill-surface-white"},{default:U(()=>[a("a",{href:`mailto:${s.stuemail_rc}`},[k(i(q),{class:"w-5 h-5 text-blue-300"})],8,ve)]),_:2},1032,["text"])])]),a("td",ye,o(s.stuname_roster),1),a("td",ge,[b.value&&!m.value?(r(),l(S,{key:0},[n.value[s.student]?(r(),l("span",ke,o(e.__("Present")),1)):(r(),l("span",we,o(e.__("Absent")),1))],64)):H((r(),l("input",{key:1,type:"checkbox","onUpdate:modelValue":h=>n.value[s.student]=h},null,8,Ce)),[[J,n.value[s.student]]])])]))),128))])])):w("",!0),c.value?(r(),l("div",Se,[a("p",xe,[a("span",Ne,o(A.value),1),$(" "+o(e.__("Present"))+", ",1),a("span",Ae,o(E.value),1),$(" "+o(e.__("Absent")),1)])])):w("",!0),c.value&&(!b.value||b.value&&m.value)?(r(),l("div",De,[a("button",{class:"p-2 bg-blue-500 text-white rounded-md",onClick:R},o(e.__("Mark Attendance")),1)])):w("",!0)]))])])],64)}}},Ve=K(je,[["__scopeId","data-v-3ff64cf7"]]);export{Ve as default};
//# sourceMappingURL=StudentAttendanceCS-CPIROWLX.js.map
