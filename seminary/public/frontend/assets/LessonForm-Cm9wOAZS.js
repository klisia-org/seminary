var D=Object.defineProperty;var V=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var z=(d,n,i)=>n in d?D(d,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):d[n]=i,M=(d,n)=>{for(var i in n||(n={}))K.call(n,i)&&z(d,i,n[i]);if(V)for(var i of V(n))Y.call(n,i)&&z(d,i,n[i]);return d};import{r as _,bk as Q,av as G,bY as H,am as W,bg as X,c as A,t as Z,b as ee,g as a,e as c,u as p,w as se,C as te,D as b,L as oe,n as re,b_ as ne,R as ie}from"./vendor-CA0oFrry.js";import{c as h,t as y,u as ae,q as le,w}from"./frappe-ui-BC6vlBMo.js";import{g as ue,u as de}from"./index-Bde-fBPp.js";import{c as O}from"./index-aYBfEZmz.js";import{u as ce}from"./settings-BDNxgcls.js";import"./Link-Dl_y0tb2.js";/* empty css                                                                     */const pe={class:""},me={class:"grid md:grid-cols-[75%,25%] h-screen"},fe={class:"border-r"},he={class:"sticky top-0 z-10 flex flex-col md:flex-row md:items-center justify-between border-b overflow-hidden bg-surface-white px-3 py-2.5 sm:px-5"},ye={class:"py-5"},ve={class:"w-5/6 mx-auto"},_e={class:"border-t mt-4"},be={class:"w-5/6 mx-auto pt-4"},we={class:"block font-medium text-ink-gray-5 mb-1"},ge={id:"instructor-notes",class:"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none !whitespace-normal py-3"},Ne={class:"border-t mt-4"},xe={class:"w-5/6 mx-auto pt-4"},Se={class:"block font-medium text-ink-gray-5 mb-1"},Ae={__name:"LessonForm",props:{courseName:{type:String,required:!0},chapterNumber:{type:String,required:!0},lessonNumber:{type:String,required:!0}},setup(d){const n=_(null),i=_(null),g=Q("$user"),m=_(!1);ce();let N,f=!1;const l=d;localStorage.setItem("activeCourseName",l.courseName),G(()=>{var e,s;!((e=g.data)!=null&&e.is_moderator)&&!((s=g.data)!=null&&s.is_instructor)&&(window.location.href="/login"),O("lesson_form_opened"),n.value=x("content"),i.value=x("instructor-notes"),window.addEventListener("keydown",S)});const x=e=>new H({holder:e,tools:ue(),autofocus:!0,defaultBlock:"markdown"}),r=W({lesson_title:"",preview:"",body:"",instructor_notes:"",content:"",discussion_id:null}),u=h({url:"seminary.seminary.utils.get_lesson_creation_details",params:{course:l.courseName,chapter:l.chapterNumber,lesson:l.lessonNumber},auto:!0,onSuccess(e){var s;e.lesson&&(Object.keys(e.lesson).forEach(t=>{r[t]=e.lesson[t]}),r.include_in_preview=!!((s=e==null?void 0:e.lesson)!=null&&s.include_in_preview),P(e),R(e),T())}}),P=e=>{n.value.isReady.then(()=>{if(e.lesson.content)n.value.render(JSON.parse(e.lesson.content));else if(e.lesson.body){let s=L(e.lesson);n.value.render({blocks:s})}})},R=e=>{i.value.isReady.then(()=>{if(e.lesson.instructor_content)i.value.render(JSON.parse(e.lesson.instructor_content));else if(e.lesson.instructor_notes){let s=L(e.lesson);i.value.render({blocks:s})}})},T=()=>{N=setInterval(()=>{v({showSuccessMessage:!1})},1e4)},S=e=>{e.key==="s"&&(e.ctrlKey||e.metaKey)&&!e.target.classList.contains("ProseMirror")&&(v({showSuccessMessage:!0}),e.preventDefault())};X(()=>{localStorage.removeItem("activeCourseName"),clearInterval(N),window.removeEventListener("keydown",S)});const B=h({url:"frappe.client.insert",makeParams(e){return{doc:M({doctype:"Course Lesson",course_sc:l.courseName,chapter:u.data.chapter.name},r)}}}),$=h({url:"frappe.client.set_value",makeParams(e){return{doctype:"Course Lesson",name:e.lesson,fieldname:r}}}),j=h({url:"frappe.client.insert",makeParams(e){var s;return{doc:{doctype:"Course Schedule Lesson Reference",parent:(s=u.data)==null?void 0:s.chapter.name,parenttype:"Course Schedule Chapter",parentfield:"lessons",lesson:e.lesson,idx:l.lessonNumber}}}}),L=e=>{let s=[];if(e.youtube){let t=e.youtube.split("/").pop();s.push({type:"embed",data:{service:"youtube",embed:`https://www.youtube.com/embed/${t}`}})}return e.body.split(`
`).forEach(t=>{if(t.includes("{{ YouTubeVideo")){let o=t.match(/\(["']([^"']+?)["']\)/)[1];o.includes("https://")||(o=`https://www.youtube.com/embed/${o}`),s.push({type:"embed",data:{service:"youtube",embed:o}})}else if(t.includes("{{ Quiz")){let o=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"quiz",data:{quiz:o}})}else if(t.includes("{{ Exam")){let o=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"exam",data:{exam:o}})}else if(t.includes("{{ DiscussionActivity")){let o=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"discussionActivity",data:{discussionID:o}})}else if(t.includes("{{ Folder")){let o=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"folder",data:{folder:o}})}else if(t.includes("{{ Video")){let o=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"upload",data:{file_url:o,file_type:o.split(".").pop()}})}else if(t.includes("{{ Audio")){let o=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"upload",data:{file_url:o,file_type:o.split(".").pop()}})}else if(t.includes("{{ PDF")){let o=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"upload",data:{file_url:o,file_type:"pdf"}})}else if(t.includes("{{ Embed")){let o=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"embed",data:{service:o.split("|||")[0],embed:o.split("|||")[1]}})}else if(t.includes("![]")){let o=t.match(/\((.*?)\)/)[1];s.push({type:"upload",data:{file_url:o,file_type:"image"}})}else if(t.includes("#")){let o=(t.match(/#/g)||[]).length;s.push({type:"header",data:{text:t.replace(/#/g,"").trim(),level:o}})}else s.push({type:"paragraph",data:{text:t}})}),e.quizId&&s.push({type:"quiz",data:{quiz:e.quizId}}),e.examId&&s.push({type:"exam",data:{exam:e.examId}}),e.discussionID&&s.push({type:"discussionActivity",data:{discussionID:e.discussionID}}),e.folder&&s.push({type:"folder",data:{folder:e.folder}}),s},v=e=>{f=!1,typeof e!="undefined"&&e.showSuccessMessage&&(f=!0),n.value.save().then(s=>{console.log("Editor Output Data:",s),r.content=JSON.stringify(s),i.value.save().then(t=>{var I;console.log("Instructor Editor Output Data:",t),r.instructor_content=JSON.stringify(t);const o=t.blocks.find(E=>{var q;return["discussionActivity","discussionactivity"].includes(E.type)&&((q=E.data)==null?void 0:q.discussionID)});r.discussion_id=o?o.data.discussionID:null,(!r.discussion_id||f)&&console.log("Lesson Object Before Save:",r),(I=u.data)!=null&&I.lesson?F():k()})})},k=()=>{B.submit({},{validate(){return C()},onSuccess(e){j.submit({lesson:e.name},{onSuccess(){O("lesson_created"),y.success(__("Lesson created successfully")),u.reload()}})},onError(e){var s;y.error(((s=e.messages)==null?void 0:s[0])||e)}})},F=()=>{$.submit({lesson:u.data.lesson.name},{validate(){return C()},onSuccess(){console.log("Lesson updated successfully"),f&&y.success(__("Lesson updated successfully"))},onError(e){var s;y.error(((s=e.messages)==null?void 0:s[0])||e)}})},C=()=>{if(!r.lesson_title)return"Title is required";if(!r.content)return"Content is required"},J=A(()=>{var s,t,o;let e=[{label:"Courses",route:{name:"Courses"}},{label:(s=u.data)==null?void 0:s.course_title,route:{name:"CourseForm",params:{courseName:l.courseName}}}];return(t=u==null?void 0:u.data)!=null&&t.lesson&&e.push({label:u.data.lesson.lesson_title,route:{name:"Lesson",params:{courseName:l.courseName,chapterNumber:l.chapterNumber,lessonNumber:l.lessonNumber}}}),e.push({label:(o=u==null?void 0:u.data)!=null&&o.lesson?"Edit Lesson":"Create Lesson",route:{name:"LessonForm",params:{courseName:l.courseName,chapterNumber:l.chapterNumber,lessonNumber:l.lessonNumber}}}),e}),U=A(()=>({title:"Lesson Editor",description:"Create and edit lessons for your course"}));return de(U),(e,s)=>(ee(),Z("div",pe,[a("div",me,[a("div",fe,[a("header",he,[c(p(ae),{class:"text-ellipsis",items:J.value},null,8,["items"]),c(p(le),{variant:"solid",onClick:s[0]||(s[0]=t=>v({showSuccessMessage:!0})),class:"mt-3 md:mt-0"},{default:se(()=>[te(b(e.__("Save")),1)]),_:1})]),a("div",ye,[a("div",ve,[c(p(w),{modelValue:r.lesson_title,"onUpdate:modelValue":s[1]||(s[1]=t=>r.lesson_title=t),label:"Title",class:"mb-4",required:!0},null,8,["modelValue"]),c(p(w),{modelValue:r.preview,"onUpdate:modelValue":s[2]||(s[2]=t=>r.preview=t),type:"text",label:"Text for Preview on the Course Page"},null,8,["modelValue"]),c(p(w),{modelValue:r.allow_discuss,"onUpdate:modelValue":s[3]||(s[3]=t=>r.allow_discuss=t),type:"checkbox",label:"Allow Discussions? (Discussions will be automatically disabled for quizzes)"},null,8,["modelValue"])]),a("div",_e,[a("div",be,[a("div",{class:"flex justify-between cursor-pointer",onClick:s[4]||(s[4]=()=>{m.value=!m.value})},[a("label",we,b(e.__("Instructor Notes")),1),c(p(ne),{class:re(["stroke-2 h-5 w-5 text-ink-gray-5",{"rotate-90 transform duration-200":m.value,"duration-200":!m.value}])},null,8,["class"])]),oe(a("div",ge,null,512),[[ie,m.value]])])]),a("div",Ne,[a("div",xe,[a("label",Se,b(e.__("Content")),1),s[5]||(s[5]=a("div",{id:"content",class:"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none !whitespace-normal py-3"},null,-1))])])])])])]))}};export{Ae as default};
//# sourceMappingURL=LessonForm-Cm9wOAZS.js.map
