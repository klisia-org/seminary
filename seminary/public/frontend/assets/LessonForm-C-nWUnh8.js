var J=Object.defineProperty;var L=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var E=(c,o,n)=>o in c?J(c,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):c[o]=n,k=(c,o)=>{for(var n in o||(o={}))F.call(o,n)&&E(c,n,o[n]);if(L)for(var n of L(o))U.call(o,n)&&E(c,n,o[n]);return c};import{r as _,A as K,d as Q,b as h,I as Y,l as q,c as D,a,h as p,e as m,w as G,t as y,s as H,O as W,Q as X,i as Z,o as ee,q as se,_ as te}from"./index-D2hg7nHX.js";import{_ as re}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-Dx4-1JCs.js";import{g as oe,j as ne,u as ae,_ as I}from"./index-CUzxg6RN.js";import{A as le}from"./editorjs-BBAOM42g.js";import{c as V,C as ie}from"./telemetry-CE2EJSOe.js";import{u as ue}from"./settings-CXJgiWd5.js";import"./table-DhGkjCET.js";import"./ListView-6JS4BnER.js";const ce={class:""},de={class:"grid md:grid-cols-[75%,25%] h-screen"},pe={class:"border-r"},me={class:"sticky top-0 z-10 flex flex-col md:flex-row md:items-center justify-between border-b overflow-hidden bg-surface-white px-3 py-2.5 sm:px-5"},fe={class:"py-5"},he={class:"w-5/6 mx-auto"},be={class:"border-t mt-4"},ve={class:"w-5/6 mx-auto pt-4"},_e={class:"block font-medium text-ink-gray-5 mb-1"},ye={id:"instructor-notes",class:"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none !whitespace-normal py-3"},we={class:"border-t mt-4"},ge={class:"w-5/6 mx-auto pt-4"},Ne={class:"block font-medium text-ink-gray-5 mb-1"},ze={__name:"LessonForm",props:{courseName:{type:String,required:!0},chapterNumber:{type:String,required:!0},lessonNumber:{type:String,required:!0}},setup(c){const o=_(null),n=_(null),w=Z("$user"),d=_(!1);ue();let g,b=!1;const i=c;K(()=>{var e,s;!((e=w.data)!=null&&e.is_moderator)&&!((s=w.data)!=null&&s.is_instructor)&&(window.location.href="/login"),V("lesson_form_opened"),o.value=N("content"),n.value=N("instructor-notes"),window.addEventListener("keydown",x)});const N=e=>new le({holder:e,tools:oe(),autofocus:!0,defaultBlock:"markdown"}),u=Q({lesson_title:"",preview:"",body:"",instructor_notes:"",content:""}),l=h({url:"seminary.seminary.utils.get_lesson_creation_details",params:{course:i.courseName,chapter:i.chapterNumber,lesson:i.lessonNumber},auto:!0,onSuccess(e){var s;e.lesson&&(Object.keys(e.lesson).forEach(t=>{u[t]=e.lesson[t]}),u.include_in_preview=!!((s=e==null?void 0:e.lesson)!=null&&s.include_in_preview),z(e),M(e),T())}}),z=e=>{o.value.isReady.then(()=>{if(e.lesson.content)o.value.render(JSON.parse(e.lesson.content));else if(e.lesson.body){let s=S(e.lesson);o.value.render({blocks:s})}})},M=e=>{n.value.isReady.then(()=>{if(e.lesson.instructor_content)n.value.render(JSON.parse(e.lesson.instructor_content));else if(e.lesson.instructor_notes){let s=S(e.lesson);n.value.render({blocks:s})}})},T=()=>{g=setInterval(()=>{v({showSuccessMessage:!1})},1e4)},x=e=>{e.key==="s"&&(e.ctrlKey||e.metaKey)&&!e.target.classList.contains("ProseMirror")&&(v({showSuccessMessage:!0}),e.preventDefault())};Y(()=>{clearInterval(g),window.removeEventListener("keydown",x)});const P=h({url:"frappe.client.insert",makeParams(e){return{doc:k({doctype:"Course Lesson",course_sc:i.courseName,chapter:l.data.chapter.name},u)}}}),O=h({url:"frappe.client.set_value",makeParams(e){return{doctype:"Course Lesson",name:e.lesson,fieldname:u}}}),R=h({url:"frappe.client.insert",makeParams(e){var s;return{doc:{doctype:"Course Schedule Lesson Reference",parent:(s=l.data)==null?void 0:s.chapter.name,parenttype:"Course Schedule Chapter",parentfield:"lessons",lesson:e.lesson,idx:i.lessonNumber}}}}),S=e=>{let s=[];if(e.youtube){let t=e.youtube.split("/").pop();s.push({type:"embed",data:{service:"youtube",embed:`https://www.youtube.com/embed/${t}`}})}return e.body.split(`
`).forEach(t=>{if(t.includes("{{ YouTubeVideo")){let r=t.match(/\(["']([^"']+?)["']\)/)[1];r.includes("https://")||(r=`https://www.youtube.com/embed/${r}`),s.push({type:"embed",data:{service:"youtube",embed:r}})}else if(t.includes("{{ Quiz")){let r=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"quiz",data:{quiz:r}})}else if(t.includes("{{ Video")){let r=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"upload",data:{file_url:r,file_type:r.split(".").pop()}})}else if(t.includes("{{ Audio")){let r=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"upload",data:{file_url:r,file_type:r.split(".").pop()}})}else if(t.includes("{{ PDF")){let r=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"upload",data:{file_url:r,file_type:"pdf"}})}else if(t.includes("{{ Embed")){let r=t.match(/\(["']([^"']+?)["']\)/)[1];s.push({type:"embed",data:{service:r.split("|||")[0],embed:r.split("|||")[1]}})}else if(t.includes("![]")){let r=t.match(/\((.*?)\)/)[1];s.push({type:"upload",data:{file_url:r,file_type:"image"}})}else if(t.includes("#")){let r=(t.match(/#/g)||[]).length;s.push({type:"header",data:{text:t.replace(/#/g,"").trim(),level:r}})}else s.push({type:"paragraph",data:{text:t}})}),e.quizId&&s.push({type:"quiz",data:{quiz:e.quizId}}),s},v=e=>{b=!1,typeof e!="undefined"&&e.showSuccessMessage&&(b=!0),o.value.save().then(s=>{u.content=JSON.stringify(s),n.value.save().then(t=>{var r;u.instructor_content=JSON.stringify(t),(r=l.data)!=null&&r.lesson?j():$()})})},$=()=>{P.submit({},{validate(){return C()},onSuccess(e){R.submit({lesson:e.name},{onSuccess(){V("lesson_created"),f("Success","Lesson created successfully","check"),l.reload()}})},onError(e){f("Error",e.message,"x")}})},j=()=>{O.submit({lesson:l.data.lesson.name},{validate(){return C()},onSuccess(){b&&f("Success","Lesson updated successfully","check")},onError(e){f("Error",e.message,"x")}})},C=()=>{if(!u.lesson_title)return"Title is required";if(!u.content)return"Content is required"},f=(e,s,t)=>{ne({lesson_title:e,text:s,icon:t,iconClasses:t=="check"?"bg-surface-green-3 text-ink-white rounded-md p-px":"bg-surface-red-5 text-ink-white rounded-md p-px",position:t=="check"?"bottom-right":"top-center",timeout:t=="check"?5:10})},A=q(()=>{var s,t,r;let e=[{label:"Courses",route:{name:"Courses"}},{label:(s=l.data)==null?void 0:s.course_title,route:{name:"CourseForm",params:{courseName:i.courseName}}}];return(t=l==null?void 0:l.data)!=null&&t.lesson&&e.push({label:l.data.lesson.lesson_title,route:{name:"Lesson",params:{courseName:i.courseName,chapterNumber:i.chapterNumber,lessonNumber:i.lessonNumber}}}),e.push({label:(r=l==null?void 0:l.data)!=null&&r.lesson?"Edit Lesson":"Create Lesson",route:{name:"LessonForm",params:{courseName:i.courseName,chapterNumber:i.chapterNumber,lessonNumber:i.lessonNumber}}}),e}),B=q(()=>({title:"Lesson Editor",description:"Create and edit lessons for your course"}));return ae(B),(e,s)=>(ee(),D("div",ce,[a("div",de,[a("div",pe,[a("header",me,[p(m(re),{class:"text-ellipsis",items:A.value},null,8,["items"]),p(m(te),{variant:"solid",onClick:s[0]||(s[0]=t=>v({showSuccessMessage:!0})),class:"mt-3 md:mt-0"},{default:G(()=>[se(y(e.__("Save")),1)]),_:1})]),a("div",fe,[a("div",he,[p(m(I),{modelValue:u.lesson_title,"onUpdate:modelValue":s[1]||(s[1]=t=>u.lesson_title=t),label:"Title",class:"mb-4",required:!0},null,8,["modelValue"]),p(m(I),{modelValue:u.preview,"onUpdate:modelValue":s[2]||(s[2]=t=>u.preview=t),type:"text",label:"Text for Preview on the Course Page"},null,8,["modelValue"])]),a("div",be,[a("div",ve,[a("div",{class:"flex justify-between cursor-pointer",onClick:s[3]||(s[3]=()=>{d.value=!d.value})},[a("label",_e,y(e.__("Instructor Notes")),1),p(m(ie),{class:H(["stroke-2 h-5 w-5 text-ink-gray-5",{"rotate-90 transform duration-200":d.value,"duration-200":!d.value}])},null,8,["class"])]),W(a("div",ye,null,512),[[X,d.value]])])]),a("div",we,[a("div",ge,[a("label",Ne,y(e.__("Content")),1),s[4]||(s[4]=a("div",{id:"content",class:"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none !whitespace-normal py-3"},null,-1))])])])])])]))}};export{ze as default};
